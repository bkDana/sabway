<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="managerOrder">
	<select id="totalCount" parameterType="search" resultType="_int">
		select count(*) cnt from m_order_tbl
		<trim prefix="where" prefixOverrides="AND|OR">
			  <if test="delDay!=null and delDay!=''">
				and m_order_del_date=#{delDay}
			</if>
			  <if test="state!='-1'">
			  	and m_order_state=#{state}
		 		</if>
			
		</trim>
		<choose>
  			<when test="mgrId.equals('admin')">
  				
  				
  			</when>
  			<otherwise>
  				where m_order_manager_id = #{mgrId}
  				<if test="state!='-1'">
			  		and m_order_state=#{state}
			  	</if>
			  	<if test="delDay!=null and delDay!=''">
			  		and m_order_del_date=#{delDay}
			  	</if>
  			</otherwise>
  		</choose>
	</select>
	<select id="selectList" parameterType="search" resultType="mOrder">
  		select 
  			rnum,
  			m_order_no as mOrderNo,
	  		m_order_manager_id as mOrderManagerId,
	  		m_order_title as mOrderTitle,
	  		m_order_del_date as mOrderDelDate,
	  		m_order_state as mOrderState,
	  		TO_CHAR(m_order_date,'YYYY-MM-DD HH24:mi:ss') as mOrderDate,
	  		mgr_name as mgrName
	  	from ( select 
	  				rownum rnum,
	  				mo.* 
	  			from (select * from m_order_tbl mot, manager m
	  			where mot.m_order_manager_id = m.mgr_id
	  			<if test="state!='-1'">
			  		and mot.m_order_state=#{state}
			  	</if>
			  	<if test="delDay!=null and delDay!=''">
			  		and mot.m_order_del_date=#{delDay}
			  	</if>
	  			<choose>
		  			<when test="mgrId.equals('admin')">
		  				
		  			</when>
		  			<otherwise>
		  				and m_order_manager_id = #{mgrId}
		  			</otherwise>
		  		</choose>
	  			order by 6 desc) mo
  			 )
  		where 
  			rnum between #{start} and #{end}
  	</select>
  	<insert id="addOrder" parameterType="mOrder">
  		insert into m_order_tbl values(#{mOrderNo},#{mOrderManagerId},#{mOrderTitle},#{mOrderDelDate},0,sysdate)
  	</insert>
  	<insert id="addItem" parameterType="item">
  		insert into m_item_tbl values(m_item_seq.nextval,#{mOrderNo},#{itemIdx},#{mItemName},#{mItemAmount})
  	</insert>
  	<select id="selectOrder" parameterType="string" resultType="mOrder">
  		select 
  			m_order_no as mOrderNo,
	  		m_order_manager_id as mOrderManagerId,
	  		m_order_title as mOrderTitle,
	  		TO_CHAR(m_order_del_date,'YYYY-MM-DD') as mOrderDelDate,
	  		m_order_state as mOrderState,
	  		TO_CHAR(m_order_date,'YYYY-MM-DD HH24:mi:ss') as mOrderDate
	  	from 
	  		m_order_tbl
  		where 
  			m_order_no = #{no}
  	</select>
  	<select id="selectItem" parameterType="string" resultType="item">
  		select 
  			m_item_idx as mItemIdx,
	  		item_idx as itemIdx,
	  		m_item_name as mItemName,
	  		m_item_amount as mItemAmount
	  	from 
	  		m_item_tbl
  		where 
  			m_order_no = #{no}
  	</select>
  	<!-- 
  	<select id="selectType" resultType="string">
  		select distinct ingre_type from ingredients
  	</select>
  	 -->
  	<select id="selectIngre" parameterType="string" resultType="ingre">
  		select
  			ingre_idx as ingreIdx,
  			ingre_label as ingreLabel,
  			ingre_unit as ingreUnit
  		from 
  			ingredients
  		where 
  			ingre_type = #{type}
  		order by 1
  	</select>
  	<update id="updateState" parameterType="mOrder">
  		update 
  			m_order_tbl 
  		set 
  			m_order_state=#{mOrderState}
  		where 
  			m_order_no=#{mOrderNo}
  	</update>
</mapper>
